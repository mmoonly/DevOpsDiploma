# Alertmanager Role

This Ansible role deploys and manages the Prometheus **Alertmanager** service, which handles alerts generated by Prometheus and sends notifications via Telegram. It supports configuration, service management, and optional cleanup of the Alertmanager setup.

## Requirements

- Ubuntu 24.04 (or a compatible Linux distribution).
- Docker and Docker Compose installed.
- Ansible for role execution.
- Access to a Telegram bot with a valid `bot_token` and `chat_id` for notifications.
- Encrypted secrets file (`ansible/vars/secrets/secrets.yml`) with Telegram credentials.

## Role Variables

Defined in `defaults/main.yml`:

- `alertmanager_version: "latest"`: Version of the Alertmanager Docker image.
- `alertmanager_port: 9093`: Port for accessing Alertmanager.
- `alertmanager_config_dir: "/data/alertmanager/configs"`: Directory for configuration files.
- `alertmanager_data_dir: "/data/alertmanager/data"`: Directory for persistent data.
- `alertmanager_flush: false`: If `true`, removes Alertmanager service, container, and directories.
- `telegram_bot_token: 123`: Placeholder for Telegram bot token (must be overridden in `ansible/vars/secrets/secrets.yml`).
- `telegram_chat_id: 123`: Placeholder for Telegram chat ID (must be overridden in `ansible/vars/secrets/secrets.yml`).

Variables from `ansible/vars/secrets/secrets.yml` (encrypted):
- `telegram_bot_token`: Actual Telegram bot token.
- `telegram_chat_id`: Actual Telegram chat ID.

**Note**: The `telegram_bot_token` and `telegram_chat_id` in `defaults/main.yml` are placeholders (`123`) and **must** be overridden with actual values in `ansible/vars/secrets/secrets.yml` for Alertmanager to send Telegram notifications.

## Role Tasks

The role performs the following tasks based on the `alertmanager_flush` variable:

### When `alertmanager_flush=true`
- Stops the Alertmanager service.
- Removes the Alertmanager Docker container.
- Deletes configuration (`/data/alertmanager/configs`) and data (`/data/alertmanager/data`) directories.
- Removes the systemd unit file (`/etc/systemd/system/alertmanager.service`).
- Resets failed service states and reloads systemd.

### When `alertmanager_flush=false`
- Loads encrypted secrets from `ansible/vars/secrets/secrets.yml`.
- Installs Docker and Docker Compose.
- Creates configuration and data directories with appropriate permissions.
- Deploys the Alertmanager configuration file (`alertmanager.yml`) from `templates/alertmanager.yml.j2`.
- Copies the Telegram notification template (`telegram.tmpl`) to the configuration directory.
- Creates and enables the systemd unit file (`alertmanager.service`) from `templates/alertmanager.service.j2`.
- Starts the Alertmanager service.

## Configuration Details

- **Alertmanager Configuration** (`templates/alertmanager.yml.j2`):
  - Defines global settings (e.g., `resolve_timeout: 1m`).
  - Configures routing to group alerts by `alertname` with specified intervals (`group_wait: 30s`, `group_interval: 1m`, `repeat_interval: 4h`).
  - Sets up a Telegram receiver with HTML-formatted messages using the `telegram.tmpl` template.
  - Mounts configuration and data volumes to `/etc/alertmanager` and `/alertmanager` in the Docker container.

- **Telegram Template** (`files/telegram.tmpl`):
  - Formats alerts as HTML messages for Telegram, including:
    - Alert name, severity (critical or warning), summary, and description.
    - Sorted labels for each alert.
    - Separate sections for firing and resolved alerts.

- **Systemd Service** (`templates/alertmanager.service.j2`):
  - Runs Alertmanager as a Docker container, mapping the specified port and volumes.
  - Ensures the service restarts automatically and depends on Docker.

## Example Playbook

```yaml
- hosts: monitoring
  roles:
    - role: alertmanager
```

## Usage

1. Ensure `ansible/vars/secrets/secrets.yml` contains valid `telegram_bot_token` and `telegram_chat_id`.
2. Include the role in your playbook and set variables as needed.
3. Run the playbook with the vault password file:
   ```bash
   ANSIBLE_VAULT_PASSWORD_FILE=vault_pass.txt ansible-playbook -i inventories/hosts.yml playbooks/setup.yml
   ```
4. Access Alertmanager at `http://<monitoring_server_ip>:9093`.

## Author Information

This role is part of the **DevOpsDiploma** project. For feedback or contributions, open an issue or pull request on [GitHub](https://github.com/mmoonly/DevOpsDiploma).
